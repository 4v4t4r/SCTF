{% extends "sctf/base.html" %}
{% block title %}Security CTF | Challenges{% endblock %}
{% load challenges_tags %}
{% block content %}

<!-- page content -->
<div class="right_col" role="main" style="min-height: 5364px;">
	<div class="">
		<div class="page-title">
			<div class="title_left">
				<!--<h3>Challenges Categories</h3>-->
			</div>		
		</div>
		<div class="clearfix"></div>
		<div class="row">

	<div class="col-md-12 col-sm-12 col-xs-12">
				<div class="x_panel">
					<div class="x_title">
						<h2 class="green">ALL CHALLENGES</small></h2>
						<ul class="nav navbar-right panel_toolbox">
							<li style="margin-left: 46px;"><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
							</li>
						</ul>
						<div class="clearfix"></div>
					</div>
					<div class="x_content">
						<div class="bs-example" data-example-id="simple-jumbotron">
							<div class="jumbotron">
								<h1 style="text-align: center;"><i class="fa fa-group"></i> You're playing for <span class="green"> {{team.name}}</span></h1><br>
								<h3 style="text-align:center;"><i class="fa fa-tags"></i> Categories:<span class="green"> #{{categories_num}}</span> | <i class="fa fa-bug"></i> Challenges:<span class="green"> #{{challenges_count}}</span></h3>
							</div>
						</div>
					</div>
				</div>
			</div>

			{% for category in categories %}
			<div class="clearfix"></div>
			<div class="">

			</div>
			<div class="col-md-12 col-sm-12 col-xs-12">
				<div class="x_panel">
					<div class="x_title">
						<h2><i class="fa fa-tag"></i> {{ category.name }} Category</h2>
						<ul class="nav navbar-right panel_toolbox">
							<li style="margin-left: 46px;"><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
							</li>
						</ul>
						<div class="clearfix"></div>
					</div>
					<div class="x_content">
						<!-- modals -->

						<p><i class="fa fa-bug"></i> <strong>Description</strong>: {{category.description}}</p>

							<!-- Large modal -->
							{% for challenge in category.challenges.all %}
							<button style="min-width:220px;" id="challenge_button_id_{{ challenge.id }}" type="button" class="btn {% btn_challenge_class user challenge %}" data-toggle="modal" data-target="#dialog_challenge_{{ challenge.id }}">{{challenge.name}}<span style="margin-left:10px;" class="label label-warning">Points: {{challenge.points}}</span></button>
							<div class="modal fade bs-example-modal-lg" id="dialog_challenge_{{ challenge.id }}" tabindex="-1" role="dialog" aria-hidden="true">
								<div class="modal-dialog modal-lg">
									<div class="modal-content">

										<div class="modal-header">
											<button type="button" class="close" data-dismiss="modal" onclick="redirect()"><span aria-hidden="true">Ã—</span>
											</button>
											{% challenge_is_solved as solved %}
											{% if solved %}
											<h2 class="modal-title" id="myModalLabel"><strong>{{challenge.name}}</strong></h2>
											<span class="label label-default">Category: {{challenge.category}}</span>
											<span class="label label-warning">Points: {{challenge.points}}</span>
											<span class="label label-success">Status: SOLVED</span>
											{% else %}
											<h2 class="modal-title" id="myModalLabel"><strong>{{challenge.name}}</strong></h2>
											<span class="label label-default">Category: {{challenge.category}}</span>
											<span class="label label-warning">Points: {{challenge.points}}</span>
											<span class="label label-danger">Status: NOT SOLVED</span>
											{% endif %}

										</div>

										<div class="x_panel">
											<div class="x_content">
												<div class="" role="tabpanel" data-example-id="togglable-tabs">
													<ul id="myTab" class="nav nav-tabs bar_tabs" role="tablist">
														<li role="presentation" class="active"><a href="#tab_content1_{{ challenge.id }}" id="home-tab" role="tab" data-toggle="tab" aria-expanded="true">Challenge</a>
														</li>
														<li role="presentation" class=""><a href="#tab_content2_{{ challenge.id }}" role="tab" id="profile-tab" data-toggle="tab" aria-expanded="false">Last 10 Solves</a>
														</li>                        
													</ul>
													<div id="myTabContent" class="tab-content">
														<div role="tabpanel" class="tab-pane fade active in" id="tab_content1_{{ challenge.id }}" aria-labelledby="home-tab">

															<div class="modal-body">
																<p style="margin-bottom:20px;"><i class="fa fa-bug"></i><strong> Description</strong>:<br> {{challenge.description|safe}}</p>

																{% for hint in challenge.hints.all %}
																<div class="col-md-12 col-sm-12 col-xs-12">
																	<div class="x_panel">
																		<div class="x_title">
																			<h7><i class="fa fa-bolt"></i><strong>  Hints</strong></h7>
																			<ul class="nav navbar-right panel_toolbox">
																				<li style="margin-left: 46px;"><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
																				</li>
																			</ul>
																			<div class="clearfix"></div>
																		</div>
																		<div class="x_content" style="display: none;">
																			<p>{{hint}}</p>
																		</div>
																	</div>
																</div>
																{% endfor %}

																{% for attachment in challenge.attachments.all %}

																<p style="float:left;margin-right:15px;margin-top:15px;"><i class="fa fa-file-text"></i><strong> Attachement {{forloop.counter}}</strong>: 
																	<button type="button" onclick="window.open('/{{attachment.file.url}}', '_blank')" class="btn btn-primary">{{attachment.name}}</button>
																</p>

																{% endfor %}
																<div class="clearfix"></div>

																{% challenge_is_solved as solved %}
																{% if solved %}
																<button type="button" class="btn btn-default" data-dismiss="modal" onclick="redirect()">Close</button>
																{% else %}
																<span style="margin-bottom: 50px;" class="count green"><i class="fa fa-key"></i><strong> Key</strong>:
																</span>
																<input id="key_{{ challenge.id }}" style="margin-bottom:15px;" class="form-control col-md-7 col-xs-12" type="text" name="key" required="required"  type="text">
																<ul id="message_{{ challenge.id }}" class="parsley-errors-list" id="parsley-id-5"><li class="parsley-required"></li></ul>

																<div class="x_content bs-example-popovers_{{ challenge.id }}">	
																	<div style="display:none;" id="alert_{{ challenge.id }}" class="alert alert-success fade in" role="alert">
																		<p id="alert_message_{{ challenge.id }}"></p>
																	</div>
																</div>

																<div style="padding: 0px;" class="modal-footer">
																	<button type="button" class="btn btn-default" data-dismiss="modal" onclick="redirect()">Close</button>
																	<button id="send_key_{{ challenge.id }}" onclick="solve({{ challenge.id }})" value="" class="btn btn-success">Send Key</button>
																</div>	
																{% endif %}
															</div>
														</div>
														<div role="tabpanel" class="tab-pane fade" id="tab_content2_{{ challenge.id }}" aria-labelledby="profile-tab">
															<div class="x_panel">
																<div class="x_title">
																	<h2>Solves - <div style="display:inline;" class="count green">list</div></h2>
																	<ul class="nav navbar-right panel_toolbox">
																		<li style="margin-left: 46px;"><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
																		</li>
																	</ul>
																	<div class="clearfix"></div>
																</div>
																<div class="x_content" style="display: block;">

																	<table class="table table-hover">			
																		<thead>
																			<tr>
																				<th>#</th>
																				<th>Username</th>
																				<th>Team</th>
																				<th>Challenge</th>
																				<th>Date</th>
																			</tr>
																		</thead>
																		<tbody>
																		<!-- Change for witch general solution non team-specific -->
																			{% for solution in last_team_solutions %}
																			<tr>
																				<th >{{forloop.counter}}</th>
																				<td>TODO</td>
																				<td>TODO</td>
																				<td>TODO</td>
																				<td>TODO</td>
																			</tr>
																			{% endfor %}
																		</tbody>
																	</table>
																</div>
															</div>
															<div style="padding: 0px;" class="modal-footer">
																<button type="button" class="btn btn-default" data-dismiss="modal" onclick="redirect()">Close</button>

															</div>	
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>




							{% endfor %}
							<!-- /modals -->
						</div>
						
					</div>
				</div>
				{% endfor %}
<div class="col-md-12 col-sm-12 col-xs-12">
				<div class="x_panel">
					<div class="x_title">
						<h2 class="green">CHALLENGES OVERVIEW</small></h2>
						<ul class="nav navbar-right panel_toolbox">
							<li style="margin-left: 46px;"><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
							</li>
						</ul>
						<div class="clearfix"></div>
					</div>
					<div class="x_content">
						<canvas id="challengesSolvedForCategory"></canvas>
					</div>
				</div>
			</div>

			<div class="col-md-12 col-sm-12 col-xs-12">
				<div class="x_panel">
					<div class="x_title">
						<h2 class="green">TEAM MATE SOLVES</h2>
						<ul class="nav navbar-right panel_toolbox">
							<li style="margin-left: 46px;"><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
							</li>
						</ul>
						<div class="clearfix"></div>
					</div>
					<div class="x_content">
						<!--<table class="table table-hover">-->
						
						<table data-page-length='4' data-order='[[ 3, "desc" ]]' id="datatable-buttons-team-buddy-solves" class="table table-striped table-bordered">
							<thead>
								<tr>
									<th>#</th>
									<th>Username</th>
									<th>Challenge</th>
									<th>Date</th>
								</tr>
							</thead>
							<tbody>
								{% for solution in last_team_solutions %}
								<tr>
									<th scope="row">{{forloop.counter}}</th>
									<td>{{solution.user}}</td>
									<td>{{solution.challenge.name}}</td>
									<td>{{solution.datetime}}</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>

					</div>
				</div>
			</div>
			</div>
			
		</div>
	</div>
	<!-- /page content -->

	<script>
		function solve(id){
			key = $('#key_'+id);
			message = $('#message_'+id);
			alert = $('#alert_'+id);
			alert_message = $('#alert_message_'+id);

			if(key.val() == ""){
				key.addClass('parsley-error');
				message.text('This value is required.');
			}
			else {
				$.ajax({
					type: 'post',
					url: '{% url "api-challenge:solve-challenge-list" %}',
					data: {challenge: id, key: $('#key_'+id).val()},
					success: function (data) {
						key.removeClass('parsley-error');
						$("#challenge_button_id_"+id).removeClass('btn-primary').addClass('btn-success');
						alert_message.text('Nice Job! That thing that you were trying to do worked!');
						alert.removeClass('alert-danger alert-warning').addClass('alert-success');
						alert.show();
					},
					error: function (data) {
				if(data.status == "417"){ // wrong key
					key.addClass('parsley-error');
					alert_message.text('Oh Noo! Something terrible happened. Wrong Key!');
					alert.removeClass('alert-success alert-warning').addClass('alert-danger');
					alert.show();
				}
				else if(data.status == "412"){ // already solved
					key.addClass('parsley-error');			
					alert_message.text('Hey man, don\'t cheat! You have already solved this challenge ok?!');
					alert.removeClass('alert-success alert-danger').addClass('alert-warning');
					alert.show();
				}
			},
		});
				return false;
			}
		}

	// TODO: Capire come gestire il fatto che se non faccio redirect l'if sul solved non funziona (ovviamente) mostrando i bottoni.
	function redirect(){
		window.location.href="{% url 'challenges' %}";
		return false;
	}
</script>

{% endblock %}

{% block extra_js %}

<script type="text/javascript">
	$(document).ready(function() {
		init_charts();
	});
</script>

<script type="text/javascript">
	function init_charts() {

		console.log('run_charts  typeof [' + typeof (Chart) + ']');
		if( typeof (Chart) === 'undefined'){ return; }
		console.log('init_charts');

		Chart.defaults.global.legend = {
			enabled: false
		};

		  // challengesSolvedForCategory chart
		  if ($('#challengesSolvedForCategory').length ){ 
		  	var ctx = document.getElementById("challengesSolvedForCategory");
		  	var mybarChart = new Chart(ctx, {
		  		type: 'bar',
		  		data: {
		  			labels: JSON.parse("{{ categories_names | escapejs }}"),
		  			datasets: [{
		  				label: '# Total',
		  				backgroundColor: "#337ab7",
		  				data: {{ categories_num_total | escapejs }}
		  			},
		  			{
		  				label: '# Team Resolved',
		  				backgroundColor: "#5bc0de",
		  				data: {{ categories_num_done_team | escapejs }}
		  			},
		  			{
		  				label: '# You Resolved',
		  				backgroundColor: "#26B99A",
		  				data: {{ categories_num_done_user | escapejs }}
		  			}]
		  		},

		  		options: {
		  			legend: true,
		  			scales: {
		  				yAxes: [{
		  					stacked:false,
		  					ticks: {
		  						beginAtZero: true
		  					}
		  				}]
		  			},
		  		}
		  	});

		  } 
		}
	</script>

	<!-- Tables (Solves, Team Components) init -->
	<script type="text/javascript">
		$(document).ready(function() {
			init_TeamBuddySolves();
		});
	</script>

	<script type="text/javascript">
		/* DATA TABLES */
		function init_TeamBuddySolves() {
			console.log('run_datatables');
			if( typeof ($.fn.DataTable) === 'undefined'){ return; }
			console.log('init_DataTables');

			// Page challenges - Team Solves 
			var createTable_TeamBuddySolves = function() {

				if ($("#datatable-buttons-team-buddy-solves").length) {
					$("#datatable-buttons-team-buddy-solves").DataTable({
						dom: "Bfrtip",
						buttons: [
						{
							extend: "copy",
							className: "btn-sm"
						},
						{
							extend: "csv",
							className: "btn-sm"
						},
						{
							extend: "print",
							className: "btn-sm"
						},
						],
						responsive: true
					});
				}
			};

			TableManageButtons = function() {
				"use strict";
				return {
					init: function() {
							// Page challenges - Team Solves Table
							createTable_TeamBuddySolves();

						}
					};
				}();

				TableManageButtons.init();
			}
		</script>

		{% endblock %}

