{% extends "sctf/base.html" %}
{% load challenges_tags %}

{% block content %}


<!-- page content -->
<div class="right_col" role="main">
	<br />
	<div class="">
		<div class="page-title">
			<div class="title_left">
				<h3>Challenges Categories</h3>
			</div>
		</div>
		{% for category in categories %}
		<div class="clearfix"></div>
		<div class="">
			<div class="clearfix"></div>
			<div class="clearfix"></div>
		</div>
		<div class="clearfix"></div>
		<div class="">
		</div>
		<div class="col-md-12 col-sm-12 col-xs-12">
			<div class="x_panel">
				<div class="x_title">
					<h2><i class="fa fa-bug"></i> {{ category.name }}</h2>
					<ul class="nav navbar-right panel_toolbox">
						<li style="margin-left: 46px;"><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
						</li>
					</ul>
					<div class="clearfix"></div>
				</div>
				<div class="x_content">
					<!-- modals -->
					<!-- Large modal -->
					{% for challenge in category.challenges.all %}
					{% challenge_is_solved as solved %}
					{% if solved %}
						RISOLTO
					{% else %}
						DA RISOLVERE
					{% endif %}

					<button id="challenge_button_id_{{ challenge.id }}" type="button" class="btn {% btn_challenge_class user challenge %}" data-toggle="modal" data-target="#dialog_challenge_{{ challenge.id }}">{{challenge.name}}</button>
					<div class="modal fade bs-example-modal-lg" id="dialog_challenge_{{ challenge.id }}" tabindex="-1" role="dialog" aria-hidden="true">
						<div class="modal-dialog modal-lg">
							<div class="modal-content">

								<div class="modal-header">
									<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">Ã—</span>
									</button>
									<h2 class="modal-title" id="myModalLabel"><strong>{{challenge.name}} - <span class="count green">Points: {{challenge.points}}</span></strong></h2>
								</div>
								<div class="modal-body">
									<p style="margin-bottom:20px;"><i class="fa fa-bug"></i><strong> Description</strong>:<br> {{challenge.description}}</p>
									
									{% for hint in challenge.hints.all %}
									<div class="col-md-12 col-sm-12 col-xs-12">
										<div class="x_panel">
											<div class="x_title">
												<h7><i class="fa fa-bolt"></i><strong>  Hint {{forloop.counter}}</strong></h7>
												<ul class="nav navbar-right panel_toolbox">
													<li style="margin-left: 46px;"><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
													</li>

												</ul>
												<div class="clearfix"></div>
											</div>
											<div class="x_content" style="display: none;">
												<p>{{hint}}</p>
											</div>
										</div>
									</div>
									{% endfor %}

									{% for attachment in challenge.attachments.all %}

									<p style="float:left;margin-right:15px;margin-top:15px;"><i class="fa fa-file-text"></i><strong> Attachement {{forloop.counter}}</strong>: 
										<button type="button" onclick="window.open('/{{attachment.file.url}}', '_blank')" class="btn btn-primary">{{attachment.name}}</button>
									</p>

									{% endfor %}
									<div class="clearfix"></div>

									<span style="margin-bottom: 50px;" class="count green"><i class="fa fa-key"></i><strong> Key</strong>:
									</span>
									<input style="margin-bottom:15px;" class="form-control col-md-7 col-xs-12" type="text" name="key" required="required" id="key_{{ challenge.id }}" type="text">
									<p id="message_key_{{ challenge.id }}"></p>
									<div class="modal-footer">
										<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
										<button id="send_key_{{ challenge.id }}" onclick="solve({{ challenge.id }})" value="" class="btn btn-success">Send Key</button>
									</div>	
								</div>
							</div>
						</div>
					</div>
					{% endfor %}
					<!-- /modals -->
				</div>
			</div>
		</div>
		{% endfor %}
	</div>
	<div class="clearfix"></div>
</div>
<!-- /page content -->

<script>
	function solve(id){
		p = $('#message_key_'+id);
		$.ajax({
			type: 'post',
			url: '{% url "api-challenge:solve-challenge-list" %}',
			data: {challenge: id, key: $('#key_'+id).val()},
			success: function (data) {
				p.text(data);
				$("#challenge_button_id_"+id).removeClass('btn-primary').addClass('btn-success');
			},
			error: function (data) {
				if(data.status == "417"){ // wrong key
					p.text(data.responseText);
				}
				else if(data.status == "412"){ // already solved
					p.text(data.responseText);
				}
			},
		});
		return false;
	}
</script>
{% endblock %}